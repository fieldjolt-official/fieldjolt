name: Deploy to Production

on:
  push:
    branches: [main]

env:
  PLANETSCALE_ORG: ${{ secrets.PLANETSCALE_ORG }}
  PLANETSCALE_DB: ${{ secrets.PLANETSCALE_DB }}
  PLANETSCALE_BRANCH: main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup PlanetScale CLI
        uses: planetscale/setup-pscale-action@v1

      # Get production database credentials
      - name: Get database credentials
        id: db-creds
        env:
          PLANETSCALE_SERVICE_TOKEN_ID: ${{ secrets.PLANETSCALE_SERVICE_TOKEN_ID }}
          PLANETSCALE_SERVICE_TOKEN: ${{ secrets.PLANETSCALE_SERVICE_TOKEN }}
        run: |
          echo "Creating database password..."
          
          # Use password create instead of role create
          PASSWORD_JSON=$(pscale password create "$PLANETSCALE_DB" "$PLANETSCALE_BRANCH" "deploy-${{ github.run_id }}" \
            --org "$PLANETSCALE_ORG" --format json)
          
          echo "Response received, parsing..."
          
          # Parse connection details
          HOST=$(echo "$PASSWORD_JSON" | jq -r '.access_host_url')
          USERNAME=$(echo "$PASSWORD_JSON" | jq -r '.username')
          PASSWORD=$(echo "$PASSWORD_JSON" | jq -r '.plain_text')
          
          echo "Host: $HOST"
          echo "Username: $USERNAME"
          
          # Validate we got everything
          if [ -z "$HOST" ] || [ "$HOST" = "null" ] || [ -z "$USERNAME" ] || [ "$PASSWORD" = "null" ]; then
            echo "❌ Failed to parse credentials"
            echo "Full response:"
            echo "$PASSWORD_JSON" | jq '.'
            exit 1
          fi
          
          # Build PostgreSQL connection string
          DATABASE_URL="postgresql://${USERNAME}:${PASSWORD}@${HOST}/${PLANETSCALE_DB}?sslmode=require"
          
          # Mask sensitive data
          echo "::add-mask::$PASSWORD"
          echo "::add-mask::$DATABASE_URL"
          
          # Output for next steps
          echo "database_url=$DATABASE_URL" >> $GITHUB_OUTPUT
          echo "password_id=$(echo "$PASSWORD_JSON" | jq -r '.id')" >> $GITHUB_OUTPUT
          echo "✅ Credentials created"

      # Push schema changes
      - name: Push Prisma schema
        env:
          DATABASE_URL: ${{ steps.db-creds.outputs.database_url }}
        run: |
          cd packages/db
          pnpm prisma generate
          pnpm prisma db push --skip-generate
          echo "✅ Schema updated"

      # Run tests (optional)
      - name: Run tests
        env:
          DATABASE_URL: ${{ steps.db-creds.outputs.database_url }}
        run: pnpm test || echo "No tests configured yet"

      # Deploy to Vercel
      # - name: Deploy to Vercel
      #   env:
      #     VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      #     DATABASE_URL: ${{ steps.db-creds.outputs.database_url }}
      #   run: |
      #     npm install -g vercel@latest
      #     vercel deploy --prod \
      #       --token=$VERCEL_TOKEN \
      #       --build-env DATABASE_URL="$DATABASE_URL" \
      #       --env DATABASE_URL="$DATABASE_URL" \
      #       --yes

      # # Deploy to Cloudflare
      # - name: Deploy API to Cloudflare
      #   env:
      #     CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      #     DATABASE_URL: ${{ steps.db-creds.outputs.database_url }}
      #   run: |
      #     cd apps/api
      #     npx wrangler deploy --env production \
      #       --var DATABASE_URL:"$DATABASE_URL"

      # Cleanup
      - name: Cleanup database password
        if: always()
        env:
          PLANETSCALE_SERVICE_TOKEN_ID: ${{ secrets.PLANETSCALE_SERVICE_TOKEN_ID }}
          PLANETSCALE_SERVICE_TOKEN: ${{ secrets.PLANETSCALE_SERVICE_TOKEN }}
        run: |
          PASSWORD_ID="${{ steps.db-creds.outputs.password_id }}"
          if [ -n "$PASSWORD_ID" ]; then
            pscale password delete "$PLANETSCALE_DB" "$PLANETSCALE_BRANCH" "$PASSWORD_ID" \
              --org "$PLANETSCALE_ORG" --force || true
            echo "✅ Password deleted"
          fi